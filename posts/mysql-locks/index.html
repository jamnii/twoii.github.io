<!DOCTYPE html>







<html lang="en"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    <!-- i18n for `_javascript/utils/timeago.js` -->
    <meta name="day-prompt" content="days ago">
    <meta name="hour-prompt" content="hours ago">
    <meta name="minute-prompt" content="minutes ago">
    <meta name="justnow-prompt" content="just now">

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="MySql Locks" />
<meta property="og:locale" content="en" />
<meta name="description" content="锁是计算机协调多个进程或线程并发访问某一资源的机制。锁保证数据并发访问的一致性、有效性；锁冲突也是影响数据库并发访问性能的一个重要因素。锁是Mysql在服务器层和存储引擎层的的并发控制。 加锁是消耗资源的，锁的各种操作，包括获得锁、检测锁是否已解除、释放锁等。" />
<meta property="og:description" content="锁是计算机协调多个进程或线程并发访问某一资源的机制。锁保证数据并发访问的一致性、有效性；锁冲突也是影响数据库并发访问性能的一个重要因素。锁是Mysql在服务器层和存储引擎层的的并发控制。 加锁是消耗资源的，锁的各种操作，包括获得锁、检测锁是否已解除、释放锁等。" />
<link rel="canonical" href="http://192.168.222.128:4001/posts/mysql-locks/" />
<meta property="og:url" content="http://192.168.222.128:4001/posts/mysql-locks/" />
<meta property="og:site_name" content="Jamnii Shao" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-06T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MySql Locks" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"datePublished":"2021-02-06T00:00:00+08:00","@type":"BlogPosting","dateModified":"2021-02-06T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://192.168.222.128:4001/posts/mysql-locks/"},"url":"http://192.168.222.128:4001/posts/mysql-locks/","description":"锁是计算机协调多个进程或线程并发访问某一资源的机制。锁保证数据并发访问的一致性、有效性；锁冲突也是影响数据库并发访问性能的一个重要因素。锁是Mysql在服务器层和存储引擎层的的并发控制。 加锁是消耗资源的，锁的各种操作，包括获得锁、检测锁是否已解除、释放锁等。","headline":"MySql Locks","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>MySql Locks | Jamnii Shao
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Jamnii Shao">
<meta name="application-name" content="Jamnii Shao">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

</head>


  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  

  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end" lang="en">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
          
          <img src="/assets/img/avatar6.png" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Jamnii Shao</a>
    </div>
    <div class="site-subtitle font-italic">a old person of low spirited .</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/link/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>LINK</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <!--<button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>-->

      
    

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>MySql Locks</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        



<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
    
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->




<!-- images -->



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    

    

  

  
  

  




<!-- return -->







<h1 data-toc-skip>MySql Locks</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <div>
    
    

    

    By
    <em>
      
        Jamnii Shao
      
    </em>
  </div>

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago"
    date="2021-02-06 00:00:00 +0800"
    
      data-toggle="tooltip"
      data-placement="bottom"
      title="Sat, Feb  6, 2021, 12:00 AM +0800"
    >Feb  6</em>

      </span>

      <!-- lastmod date -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="6838 words">
  <em>37 min</em> read</span>


      <!-- page views -->
      
    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>锁是计算机协调多个进程或线程并发访问某一资源的机制。锁保证数据并发访问的一致性、有效性；锁冲突也是影响数据库并发访问性能的一个重要因素。锁是Mysql在服务器层和存储引擎层的的并发控制。
加锁是消耗资源的，锁的各种操作，包括获得锁、检测锁是否已解除、释放锁等。</p>

<h3 id="锁的类型">锁的类型<a href="#锁的类型"><i class="fas fa-hashtag"></i></a></h3></h3>
<p>这里主要介绍表锁和行锁。</p>

<h4 id="表锁">表锁<a href="#表锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre>表锁由 MySQL Server 实现，一般在执行 DDL(Data Definition Language) 语句时会对整个表进行加锁，
比如说 ALTER,UPDATE TABLE 等操作。
在执行 SQL 语句时，也可以明确指定对某个表进行加锁。
表锁使用的是一次性锁技术,只能访问加锁的表，不能访问其他表，直到最后通过 unlock tables 释放所有表锁
|-------
| read  |
|---------------------------------------------------------------------------------------------
|`lock table test read;` #为test表设置读锁[read|write]
|
|`select * from test where id = 1;` #成功
|
|#失败,Table 'test_2' was not locked with LOCK TABLES,没有读表锁
|`select * from test_2 where id = 2;`
|
|#Table 'test' was locked with a READ lock and can't be updated
|`update test  set name = 'one' where id = 1;` # 失败，未提前获得test的写表锁
|
|`unlock talbes;`#解锁
|`lock table test_2 read;`#此时会释放 test 的读表锁,或者 start transaction | begin 也会释放之前的锁
|---------------------------------------------------------------------------------------------

|-------
| write |
|---------------------------------------------------------------------------------------------
|`lock table test write;` #为test表设置读锁[read|write]
|
|`select * from test where id = 1;` #成功
|
|#失败,Table 'test_2' was not locked with LOCK TABLES,没有读表锁
|`select * from test_2 where id = 2;`
|
|`update test  set name = 'one' where id = 1;` # 成功
|
|`unlock tables;`#解锁
|---------------------------------------------------------------------------------------------
</pre></td></tr></tbody></table></code></div></div>

<h4 id="行锁">行锁<a href="#行锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>目前主要针对与InnoDB,行锁的机制是根据索引来的.
索引分为聚簇索引和非聚簇索引.
聚簇索引(主键索引加锁)
非聚簇索引(普通索引加锁,主键索引加锁)
范围更新加锁(内部执行:获取满足条数的第一条数据-&gt;返回并加锁-&gt;更新记录-&gt;更新成功-&gt;重复)
</pre></td></tr></tbody></table></code></div></div>

<h3 id="行锁的模式">行锁的模式<a href="#行锁的模式"><i class="fas fa-hashtag"></i></a></h3></h3>
<p>行锁的模式有很多，这里主要介绍 <code class="language-plaintext highlighter-rouge">共享锁|读锁|S锁</code>、<code class="language-plaintext highlighter-rouge">排他锁|写锁|X锁</code>、<code class="language-plaintext highlighter-rouge">意向锁</code>、<code class="language-plaintext highlighter-rouge">自增锁</code> 等。</p>

<h4 id="共享锁-读写锁-读锁">共享锁 <code class="language-plaintext highlighter-rouge">读写锁-&gt;读锁</code><a href="#共享锁-读写锁-读锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>读锁，又称共享锁（Share locks，简称 S 锁），加了读锁的记录，
所有的事务都可以读取，但是不能修改，
并且可同时有多个事务对记录加读锁。
                ts1
                 ↓
 ts2  →   [(one row data),SL]     ←   ts3
               (ts0)
</pre></td></tr></tbody></table></code></div></div>

<h4 id="排他锁-读写锁-写锁">排他锁 <code class="language-plaintext highlighter-rouge">读写锁-&gt;写锁</code><a href="#排他锁-读写锁-写锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>写锁，又称排他锁（Exclusive locks，简称 X 锁），或独占锁，
对记录加了排他锁之后，只有拥有该锁的事务可以读取和修改，
其他事务都不可以读取和修改，并且同一时间只能有一个事务加写锁。
                ts1
                 ↓
                 ↑
             我只属于ts0
 ts2  →←   [(one row data),XL]     →←   ts3
               (ts0)
</pre></td></tr></tbody></table></code></div></div>

<h4 id="意向锁intention意向">意向锁(intention:意向)<a href="#意向锁intention意向"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>由于表锁和行锁虽然锁定范围不同，但是会相互冲突。
所以当你要加表锁时，势必要先遍历该表的所有记录，判断是否加有排他锁。
这种遍历检查的方式显然是一种低效的方式，MySQL 引入了意向锁，来检测表锁和行锁的冲突。

意向锁也是表级锁，也可分为读意向锁（IS 锁）和写意向锁（IX 锁）。
当事务要在记录上加上读锁或写锁时，要首先在表上加上意向锁。
这样判断表中是否有记录加锁就很简单了，只要看下表上是否有意向锁就行了。

意向锁之间是不会产生冲突的，也不和 AUTO_INC 表锁冲突，它只会阻塞表级读锁或表级写锁，
另外，意向锁也不会和行锁冲突，行锁只会和行锁冲突。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="自增锁auto-increment">自增锁(auto increment)<a href="#自增锁auto-increment"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>AUTOINC 锁又叫自增锁（一般简写成 AI 锁），是一种表锁，当表中有自增列（AUTOINCREMENT）时出现。
当插入表中有自增列时，数据库需要自动生成自增值，它会先为该表加 AUTOINC 表锁，阻塞其他事务的插入操作，这样保证生成的自增值肯定是唯一的。
AUTOINC 锁具有如下特点：
    AUTO_INC 锁互不兼容，也就是说同一张表同时只允许有一个自增锁；
    自增值一旦分配了就会 +1，如果事务回滚，自增值也不会减回去，所以自增值可能会出现中断的情况。
显然，AUTOINC 表锁会导致并发插入的效率降低，为了提高插入的并发性，
MySQL 从 5.1.22 版本开始，引入了一种可选的轻量级锁（mutex）机制来代替 AUTOINC 锁，
可以通过参数 innodb autoinc lock mode 来灵活控制分配自增值时的并发策略。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="行锁总结">行锁总结<a href="#行锁总结"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>意向锁之间互不冲突；
S 锁只和 S/IS 锁兼容，和其他锁都冲突；
X 锁和其他所有锁都冲突；
AI 锁只和意向锁兼容；
</pre></td></tr></tbody></table></code></div></div>

<h3 id="行锁的类型">行锁的类型<a href="#行锁的类型"><i class="fas fa-hashtag"></i></a></h3></h3>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>根据锁的粒度可以把锁细分为表锁和行锁，行锁根据场景的不同又可以进一步细分，
依次为 Next-Key Lock，Gap Lock 间隙锁，Record Lock 记录锁和插入意向 GAP 锁。

不同的锁锁定的位置是不同的，
比如说记录锁只锁住对应的记录，
而间隙锁锁住记录和记录之间的间隔，
Next-Key Lock 则所属记录和记录之前的间隙。
不同类型锁的锁定范围大致如下
                      Next-Key Lock
                 ↑                   ↑
                 (Gap Lock 1)         (Gap Lock 2)         (Gap Lock 3)
(-∞)     (Key=3)              (Key=10)            (Key=20)             (+∞)
                              ↑      ↑            ↑      ↑
                           Record Lock 1        Record Lock 2
</pre></td></tr></tbody></table></code></div></div>

<h4 id="记录锁record-lock">记录锁(Record Lock)<a href="#记录锁record-lock"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>记录锁是最简单的行锁。
InnoDB 加锁原理中的锁就是记录锁，只锁住 id = 1 或者 field = 'value' 这一条记录。

当 SQL 语句无法使用索引时，会进行全表扫描，这个时候 MySQL 会给整张表的所有数据行加记录锁，
再由 MySQL Server 层进行过滤。但是，在 MySQL Server 层进行过滤的时候，如果发现不满足 WHERE 条件，会释放对应记录的锁。
这样做，保证了最后只会持有满足条件记录上的锁，但是每条记录的加锁操作还是不能省略的。

所以更新操作必须要根据索引进行操作，没有索引时，不仅会消耗大量的锁资源，增加数据库的开销，还会极大的降低了数据库的并发性能。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="间隙锁">间隙锁<a href="#间隙锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>如果 Key = 17 这条记录不存在，这个 SQL 语句还会加锁吗？
在 RC 隔离级别不会加任何锁，在 RR 隔离级别会在 Key = 17 前后两个索引之间加上间隙锁。

间隙锁是一种加在两个索引之间的锁，或者加在第一个索引之前，或最后一个索引之后的间隙。
这个间隙可以跨一个索引记录，多个索引记录，甚至是空的。
使用间隙锁可以防止其他事务在这个范围内插入或修改记录，保证两次读取这个范围内的记录不会变，从而不会出现幻读现象。

值得注意的是，间隙锁和间隙锁之间是互不冲突的，间隙锁唯一的作用就是为了防止其他事务的插入，所以加间隙 S 锁和加间隙 X 锁没有任何区别。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="next-key-锁">Next-Key 锁<a href="#next-key-锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>Next-key锁是记录锁和间隙锁的组合，它指的是加在某条记录以及这条记录前面间隙上的锁
参考 Key = 10 上的 Next-Key Lock,
(-∞,3],(3,10],(10,20],(20,+∞)
通常用这种左开右闭区间来表示 Next-key 锁，其中，圆括号表示不包含该记录，方括号表示包含该记录
RR级别下才有
</pre></td></tr></tbody></table></code></div></div>

<h4 id="插入意向锁">插入意向锁<a href="#插入意向锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>插入意向锁是一种特殊的间隙锁（简写成 II GAP）表示插入的意向，只有在 INSERT 的时候才会有这个锁。
注意，这个锁虽然也叫意向锁，但是和上面介绍的表级意向锁是两个完全不同的概念，不要搞混了。

插入意向锁和插入意向锁之间互不冲突，所以可以在同一个间隙中有多个事务同时插入不同索引的记录。
譬如，id = 30 和 id = 49 之间如果有两个事务要同时分别插入 id = 32 和 id = 33 是没问题的，
虽然两个事务都会在 id = 30 和 id = 50 之间加上插入意向锁，但是不会冲突。

插入意向锁只会和间隙锁或 Next-key 锁冲突，
正如上面所说，间隙锁唯一的作用就是防止其他事务插入记录造成幻读，
正是由于在执行 INSERT 语句时需要加插入意向锁，而插入意向锁和间隙锁冲突，从而阻止了插入操作的执行。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="总结">总结<a href="#总结"><i class="fas fa-hashtag"></i></a></h4></h4>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th style="text-align: center">\</th>
      <th style="text-align: center">record</th>
      <th style="text-align: center">gap</th>
      <th style="text-align: center">next-key</th>
      <th style="text-align: center">ii gap</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">record</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">兼容</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">兼容</td>
    </tr>
    <tr>
      <td style="text-align: center">gap</td>
      <td style="text-align: center">兼容</td>
      <td style="text-align: center">兼容</td>
      <td style="text-align: center">兼容</td>
      <td style="text-align: center">兼容</td>
    </tr>
    <tr>
      <td style="text-align: center">next-key</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">兼容</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">兼容</td>
    </tr>
    <tr>
      <td style="text-align: center">ii gap</td>
      <td style="text-align: center">兼容</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
    </tr>
  </tbody>
</table></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>其中，第一行表示已有的锁，第一列表示要加的锁。
插入意向锁较为特殊，所以我们先对插入意向锁做个总结，
如下：
    插入意向锁不影响其他事务加其他任何锁。也就是说，一个事务已经获取了插入意向锁，对其他事务是没有任何影响的；
    插入意向锁与间隙锁和 Next-key 锁冲突。也就是说，一个事务想要获取插入意向锁，
      如果有其他事务已经加了间隙锁或 Next-key 锁，则会阻塞。
    其他类型的锁的规则较为简单：
    间隙锁不和其他锁（不包括插入意向锁）冲突；
    记录锁和记录锁冲突，Next-key 锁和 Next-key 锁冲突，记录锁和 Next-key 锁冲突；
</pre></td></tr></tbody></table></code></div></div>

<h4 id="页锁">页锁<a href="#页锁"><i class="fas fa-hashtag"></i></a></h4></h4>

<h3 id="锁的排查">锁的排查<a href="#锁的排查"><i class="fas fa-hashtag"></i></a></h3></h3>
<ul>
  <li>并发事务，间隙锁可能互斥
    <ul>
      <li>A删除不存在的记录，获取共享间隙锁；</li>
      <li>B插入，必须获得排他间隙锁，故互斥；</li>
    </ul>
  </li>
  <li>并发插入相同记录，可能死锁(某一个回滚)</li>
  <li>并发插入，可能出现间隙锁死锁(难排查)</li>
  <li>show engine innodb status; 可以查看InnoDB的锁情况，也可以调试死锁</li>
  <li>show status like ‘innodb_row_lock%’;查看InnoDB_row_lock的状态</li>
  <li>show variables like ‘%lock_wait_timeout%’;</li>
</ul>

<h4 id="innodb-row-lock">Innodb Row Lock<a href="#innodb-row-lock"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>Innodb_row_lock_current_waits:当前正在等待锁的数量；

Innodb_row_lock_time:从系统启动到现在锁定总时间长度；

Innodb_row_lock_time_avg：每次等待所花平均时间；

Innodb_row_lock_time_max:从系统启动到现在等待最长的一次所花的时间长度；

Innodb_row_lock_waits:系统启动到现在总共等待的次数；

对于这5个状态变量，比较重要的是：

Innodb_row_lock_time_avg，Innodb_row_lock_waits，Innodb_row_lock_time。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="死锁">死锁<a href="#死锁"><i class="fas fa-hashtag"></i></a></h4></h4>
<ul>
  <li>复现</li>
  <li>查看事务与锁信息</li>
  <li>分析sql
    <div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>  # 设置事物隔离级别 RR
  # show variables like "%isolation%";
  # read uncommitted, read committed, repeatable read, serializable
  set session transaction isolation level repeatable read;

  # 关闭自动提交
  # show variables like "autocommit";
  set session autocommit=0;

  #开始事物
  start transaction;
  #sql
  commit;

  #查看事务与锁信息
  show engine innodb status;

  #分析sql,死锁:1.没走行锁,索引失效,全表扫描
  explain sql;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h4 id="间隙锁-互斥删除">间隙锁 互斥(删除?)<a href="#间隙锁-互斥删除"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre>#设置rr
set session transaction isolation level repeatable read;

#表信息
create table t (
id int(10) primary key
)engine=innodb;

#初始化数据
start transaction;
insert into t values(1);
insert into t values(3);
insert into t values(10);
commit;

#开启区间锁，RR的隔离级别下，上例会有四个区间
(-infinity, 1)
(1, 3)
(3, 10)
(10, infinity)

#实例1
set session autocommit=0;
start transaction;
delete from t where id=5;

#实例2
set session autocommit=0;
start transaction;
insert into t values(0);
insert into t values(2);
insert into t values(12);
insert into t values(7);

#结果
#实例1 删除某个区间内的一条不存在记录，获取到共享间隙锁，
#会阻止其他事务 实例2 在相应的区间插入数据，因为插入需要获取排他间隙锁
#实例2 插入的值：0, 2, 12都不在(3, 10)区间内，能够成功插入，而7在(3, 10)这个区间内，会阻塞。
#+++
#删除 id=5,5在区间(3,10)触发共享间隙锁,事物未提交,
#在区间(3,10)插入id=7,需要获取排他间隙锁(防止其它事物也插入id=7),但此时存在 共享间隙锁,所以会阻塞.


#验证  lock_mode
show engine innodb status;

*** (1) TRANSACTION:
TRANSACTION 788058, ACTIVE 28 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 360, 5 row lock(s), undo log entries 4
MySQL thread id 358, OS thread handle 0x7f733c67f700, query id 9079 localhost 127.0.0.1 root updating
/* ApplicationName=DataGrip 2019.2.3 */ DELETE FROM `tt`.`t` WHERE `id` = 1
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 261 page no 3 n bits 80 index `PRIMARY` of table `tt`.`t` trx id 788058 lock_mode  X locks rec but not gap waiting
Record lock, heap no 4 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
0: len 4; hex 80000001; asc     ;;
1: len 6; hex 0000000c0640; asc      @;;
2: len 7; hex fb000001fc0144; asc       D;;

#正在等待共享间隙锁的释放。
#insert into t values(7);

#如果 事务1 提交或者回滚， 事务2 就能够获得相应的锁，以继续执行。
#如果 事务2 一直不提交， 事务2 会一直等待，直到超时，超时后会显示：
#ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
</pre></td></tr></tbody></table></code></div></div>

<h4 id="共享排他锁死锁插入">共享排他锁死锁(插入?)<a href="#共享排他锁死锁插入"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>#表同 间隙锁互斥
# A
set session autocommit=0;
start transaction;
insert into t values(7);

# B
set session autocommit=0;
start transaction;
insert into t values(7);

# C
set session autocommit=0;
start transaction;
insert into t values(7);

#结果:
# 1.A先执行，插入成功，并获取id=7的排他锁；
# 2.B后执行，需要进行PK校验，故需要先获取id=7的共享锁，阻塞；
# 3.C后执行，也需要进行PK校验，也要先获取id=7的共享锁，也阻塞；
# 如果此时，session A执行：
#   rollback;
# id=7排他锁释放。
# 则B，C会继续进行主键校验：
#   (1)B会获取到id=7共享锁，主键未互斥；
#   (2)C也会获取到id=7共享锁，主键未互斥；
# B和C要想插入成功，必须获得id=7的排他锁，但由于双方都已经获取到id=7的共享锁，
# 它们都无法获取到彼此的排他锁，死锁就出现了。
# 当然，InnoDB有死锁检测机制，B和C中的一个事务会插入成功，另一个事务会自动放弃：
# ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction
</pre></td></tr></tbody></table></code></div></div>

<h4 id="并发间隙锁的死锁插入删除">并发间隙锁的死锁(插入,删除?)<a href="#并发间隙锁的死锁插入删除"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>#共享排他锁，在并发量插入相同记录的情况下会出现，相应的案例比较容易分析。
#而并发的间隙锁死锁，是比较难定位的。
#两个并发的session，其SQL执行序列如下：
A：set session autocommit=0;
A：start transaction;
A：delete from t where id=6;
         B：set session autocommit=0;
         B：start transaction;
         B：delete from t where id=7;
A：insert into t values(5);
         B：insert into t values(8);
#A执行delete后，会获得(3, 10)的共享间隙锁。
#B执行delete后，也会获得(3, 10)的共享间隙锁。
#A执行insert后，希望获得(3, 10)的排他间隙锁，于是会阻塞。
#B执行insert后，也希望获得(3, 10)的排他间隙锁，于是死锁出现。

</pre></td></tr></tbody></table></code></div></div>

<h4 id="记录锁record-locks--锁定索引记录">记录锁(Record Locks) : 锁定索引记录<a href="#记录锁record-locks--锁定索引记录"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>记录锁，它封锁索引记录，例如：
select * from t where id=1 for update;
它会在id=1的索引记录上加锁，以阻止其他事务插入，更新，删除id=1的这一行。

当有主键或者索引的时候，会形成行锁。
当无法命中索引或者无索引、范围、模糊时，会形成表锁。
明确指定索引，若无查询数据，无锁。

for update 仅适用于InnoDB，并且必须开启事务，在begin与commit之间才生效。
for update锁住表或者锁住行，只允许当前事务进行操作（读写），其他事务被阻塞，直到当前事务提交或者回滚，被阻塞的事务自动执行。
for update nowait 锁住表或者锁住行，只允许当前事务进行操作（读写），其他事务被拒绝，事务占据的statement连接也会被断开。

需要说明的是：
    select * from t where id=1;
    则是快照读(SnapShot Read)，它并不加锁.
</pre></td></tr></tbody></table></code></div></div>

<h4 id="间隙锁gap-locks--锁定间隔防止间隔中被其他事务插入">间隙锁(Gap Locks) : 锁定间隔，防止间隔中被其他事务插入<a href="#间隙锁gap-locks--锁定间隔防止间隔中被其他事务插入"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>它封锁索引记录中的间隔，或者第一条索引记录之前的范围，又或者最后一条索引记录之后的范围。
插入id=10会封锁区间，以阻止其他事务id=10的记录插入。

为什么要阻止id=10的记录插入？
如果能够插入成功，头一个事务执行相同的SQL语句，会发现结果集多出了一条记录，即幻影数据。

间隙锁的主要目的，就是为了防止其他事务在间隔中插入数据，以导致“不可重复读”。
如果把事务的隔离级别降级为读提交(Read Committed, RC)，间隙锁则会自动失效。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="临键锁next-key-locks--锁定索引记录间隔防止幻读">临键锁(Next-Key Locks) : 锁定索引记录+间隔，防止幻读<a href="#临键锁next-key-locks--锁定索引记录间隔防止幻读"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>临键锁，是记录锁与间隙锁的组合，它的封锁范围，既包含索引记录，又包含索引区间。
更具体的，临键锁会封锁索引记录本身，以及索引记录之前的区间。

如果一个会话占有了索引记录R的共享/排他锁，其他会话不能立刻在R之前的区间插入新的索引记录。
临键锁的主要目的，也是为了避免幻读(Phantom Read)。如果把事务的隔离级别降级为RC，临键锁则也会失效。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="源数据锁metadata-lock-waiting-for-table-metadata-lock">源数据锁(metadata lock) Waiting for table metadata lock<a href="#源数据锁metadata-lock-waiting-for-table-metadata-lock"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>KILL 掉某些事物占用的锁，使DDL成功，然后进而不阻塞其他DML操作。

设置锁超时短些 lock_wait_timeout

DML（data manipulation language）数据操纵语言：
    就是我们最经常用到的 SELECT、UPDATE、INSERT、DELETE。 主要用来对数据库的数据进行一些操作

DDL（data definition language）数据库定义语言：
    其实就是我们在创建表的时候用到的一些sql，比如说： CREATE、ALTER、DROP、TRUNCATE等。
    DDL主要是用在定义或改变表的结构，数据类型，表之间的链接和约束等初始化工作上。

DQL(Data Query Language) 数据查询语言DQL：
    select 相关

DCL（Data Control Language）数据库控制语言：
    是用来设置或更改数据库用户或角色权限的语句，包括（grant,deny,revoke等）语句。这个比较少用到
</pre></td></tr></tbody></table></code></div></div>

<h4 id="锁等待超时尝试重启事物-lock-wait-timeout-exceeded-try-restarting-transaction">锁等待超时，尝试重启事物 Lock wait timeout exceeded; try restarting transaction<a href="#锁等待超时尝试重启事物-lock-wait-timeout-exceeded-try-restarting-transaction"><i class="fas fa-hashtag"></i></a></h4></h4>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>出现死锁应该从锁的源头进行排查，这里需要和业务逻辑相互结合进行排查。
DB: information_schema(数据库相关信息)

Table:
innodb_trx 当前运行的所有事务
innodb_locks 当前出现的锁
innodb_lock_waits 锁等待的对应关系
可以使用 Desc 查看表结构。

通过 状态 进行排除，  kill 对应的 死锁。
select * from information_schema.innodb_trx;

设置锁的超时时间
show variables like '%lock_wait_timeout%';
</pre></td></tr></tbody></table></code></div></div>

<h4 id="死锁之多事物加锁顺序不一致">死锁之多事物加锁顺序不一致<a href="#死锁之多事物加锁顺序不一致"><i class="fas fa-hashtag"></i></a></h4></h4>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th style="text-align: center">事物A</th>
      <th style="text-align: center">事物B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">update table set value = 1 where id = 20</td>
      <td style="text-align: center">update table set value = 1 where id = 30</td>
    </tr>
    <tr>
      <td style="text-align: center">update table set value = 1 where id = 30</td>
      <td style="text-align: center">update table set value = 1 where id = 20</td>
    </tr>
  </tbody>
</table></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>AB同时执行，A获取 id = 20 的锁，B获取 id = 30 的锁。
A获取 id = 30 的锁，此时锁在B事物中，需要等待。
B获取 id = 20 的锁，此时锁在A事物中，需要等待。
AB同时等待彼此的锁，从而导致死锁。
</pre></td></tr></tbody></table></code></div></div>

<h4 id="34-如何避免死锁">3.4 如何避免死锁<a href="#34-如何避免死锁"><i class="fas fa-hashtag"></i></a></h4></h4>

<p>在工作过程中偶尔会遇到死锁问题，虽然这种问题遇到的概率不大，但每次遇到的时候要想彻底弄懂其原理并找到解决方案却并不容易。其实，对于 MySQL 的 InnoDb 存储引擎来说，死锁问题是避免不了的，没有哪种解决方案可以说完全解决死锁问题，但是我们可以通过一些可控的手段，降低出现死锁的概率。</p>

<p>如上面的案例一和案例三所示，对索引加锁顺序的不一致很可能会导致死锁，所以如果可以，尽量以相同的顺序来访问索引记录和表。在程序以批量方式处理数据的时候，如果事先对数据排序，保证每个线程按固定的顺序来处理记录，也可以大大降低出现死锁的可能；</p>

<p>如上面的案例二所示，Gap 锁往往是程序中导致死锁的真凶，由于默认情况下 MySQL 的隔离级别是 RR，所以如果能确定幻读和不可重复读对应用的影响不大，可以考虑将隔离级别改成 RC，可以避免 Gap 锁导致的死锁；</p>

<p>为表添加合理的索引，如果不走索引将会为表的每一行记录加锁，死锁的概率就会大大增大；</p>

<p>我们知道 MyISAM 只支持表锁，它采用一次封锁技术来保证事务之间不会发生死锁，所以，我们也可以使用同样的思想，在事务中一次锁定所需要的所有资源，减少死锁概率；</p>

<p>避免大事务，尽量将大事务拆成多个小事务来处理；因为大事务占用资源多，耗时长，与其他事务冲突的概率也会变高；</p>

<p>避免在同一时间点运行多个对同一表进行读写的脚本，特别注意加锁且操作数据量比较大的语句；我们经常会有一些定时脚本，避免它们在同一时间点运行；</p>

<p>设置锁等待超时参数：innodb_lock_wait_timeout，这个参数并不是只用来解决死锁问题，在并发访问比较高的情况下，如果大量事务因无法立即获得所需的锁而挂起，会占用大量计算机资源，造成严重性能问题，甚至拖跨数据库。我们通过设置合适的锁等待超时阈值，可以避免这种情况发生。</p>

<h4 id="35-业务分析">3.5 业务分析<a href="#35-业务分析"><i class="fas fa-hashtag"></i></a></h4></h4>
<p>风险提示：等待行锁</p>

<p>注册会话快照：</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">user</th>
      <th style="text-align: center">host</th>
      <th style="text-align: center">db</th>
      <th style="text-align: center">command</th>
      <th style="text-align: center">time</th>
      <th style="text-align: center">state</th>
      <th style="text-align: center">info</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">18077187</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:38548</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">44</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">DELETE FROM <code class="language-plaintext highlighter-rouge">member_third_login_test</code> WHERE <code class="language-plaintext highlighter-rouge">member_id</code> = 353424</td>
    </tr>
    <tr>
      <td style="text-align: center">18093488</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:52505</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">46</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘A’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093496</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:52613</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">46</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘B’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093491</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:52534</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">46</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘C’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093549</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:53586</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">44</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘D’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093562</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:53780</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">44</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘E’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093546</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:53494</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">44</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘F’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093680</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:55578</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">41</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘G’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093821</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:57776</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">39</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = 1 ,  WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354754</td>
    </tr>
    <tr>
      <td style="text-align: center">18093843</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:58234</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">37</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘H’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354755</td>
    </tr>
    <tr>
      <td style="text-align: center">18093820</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:57718</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">37</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘E’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354755</td>
    </tr>
    <tr>
      <td style="text-align: center">18094060</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:33288</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">33</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘O’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354755</td>
    </tr>
    <tr>
      <td style="text-align: center">18094087</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:33636</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">31</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘J’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354756</td>
    </tr>
    <tr>
      <td style="text-align: center">18094094</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:33786</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">31</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘K’ , <code class="language-plaintext highlighter-rouge">token</code> = ‘1’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354756</td>
    </tr>
    <tr>
      <td style="text-align: center">18094147</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:35052</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">31</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = 1 ,  WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354755</td>
    </tr>
    <tr>
      <td style="text-align: center">18094117</td>
      <td style="text-align: center">test</td>
      <td style="text-align: center">127.0.0.1:34122</td>
      <td style="text-align: center">dev_test</td>
      <td style="text-align: center">Execute</td>
      <td style="text-align: center">30</td>
      <td style="text-align: center">updating</td>
      <td style="text-align: center">UPDATE <code class="language-plaintext highlighter-rouge">member_account_test</code> SET <code class="language-plaintext highlighter-rouge">account</code> = ‘L’ , WHERE <code class="language-plaintext highlighter-rouge">id</code> = 354756</td>
    </tr>
  </tbody>
</table></div>

<p>分析：等待行锁</p>
<blockquote>
  <p>354754 出现了 8 次，均为 <code class="language-plaintext highlighter-rouge">update</code>，每次更新的 <code class="language-plaintext highlighter-rouge">account</code> 都不相同。</p>

  <p>注册逻辑为账号分配+事物。当并发量比较高的时候，单毫秒随机分配可能对应多个用户，<code class="language-plaintext highlighter-rouge">find one</code>、<code class="language-plaintext highlighter-rouge">get one</code>、<code class="language-plaintext highlighter-rouge">one</code> 等都会失效。</p>

  <p>比如： 用户ID <code class="language-plaintext highlighter-rouge">354754</code> 对应了 <code class="language-plaintext highlighter-rouge">8</code> 个用户。由于注册逻辑中包含了事物，导致多事物同时操作一条数据，
<code class="language-plaintext highlighter-rouge">sql 语句</code> 可能会触发 <code class="language-plaintext highlighter-rouge">锁</code> 相关的问题，导致 <code class="language-plaintext highlighter-rouge">cup</code> 处理变慢，从而导致卡顿，甚至宕机。</p>
</blockquote>

<p>分析： Gap Lock</p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">member_third_login_test</code></p>

  <p>column：<code class="language-plaintext highlighter-rouge">member_id(pk)</code>，<code class="language-plaintext highlighter-rouge">open_id</code></p>

  <p>由于 <code class="language-plaintext highlighter-rouge">member_id</code> 来源于 <code class="language-plaintext highlighter-rouge">member_account_test -&gt; id</code>，相对随机。</p>

  <p>当处于事物时，会触发 <code class="language-plaintext highlighter-rouge">Gap Lock</code> 。</p>
</blockquote>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/mysql/'>MySQL</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/mysql/"
          class="post-tag no-text-decoration" >MySQL</a>
      
      <a href="/tags/lock/"
          class="post-tag no-text-decoration" >Lock</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recent Update</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/mysql-transaction/">MySQL Transaction</a></li>
      
        
        
        
      <li><a href="/posts/getting-start/">Getting Started</a></li>
      
        
        
        
      <li><a href="/posts/how-to-build-api/">How to build you apis</a></li>
      
        
        
        
      <li><a href="/posts/hight-low-design/">高内聚低耦合</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/api/">api</a>
    
      
      <a class="post-tag" href="/tags/cgi/">CGI</a>
    
      
      <a class="post-tag" href="/tags/getting-started/">getting started</a>
    
      
      <a class="post-tag" href="/tags/lock/">Lock</a>
    
      
      <a class="post-tag" href="/tags/mysql/">MySQL</a>
    
      
      <a class="post-tag" href="/tags/php-fpm/">PHP-FPM</a>
    
      
      <a class="post-tag" href="/tags/transaction/">transaction</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
      
        
        <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->




  
    
    
      
      
        
        
        
      
    
  
    
    
      
      
    
  
    
    
  
    
    
      
      
        
        
        
          





  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/mysql-transaction/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago small"
    date="2021-02-20 16:42:00 +0800"
    >Feb 20</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL Transaction</h3>
            <div class="text-muted small">
              <p>
                





                MySQL 事务主要用于处理操作量大，复杂度高的数据。

1. 基础介绍

2. ACID

Atomicity
原子性: 一个事务被视为一个不可分割的最小工作单元 一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。

事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。

原子性关注状态，要么全部成功，要么全部失败，不存在部分成功...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/php-fpm-other/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago small"
    date="2021-02-25 00:00:00 +0800"
    >Feb 25</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型</h3>
            <div class="text-muted small">
              <p>
                





                CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型

CGI

common gateway interface (公共网关接口)


  请求模式:
        Web Brower(浏览器) —-(通过http协议传输)—-&amp;gt; Http Server(服务器nginx/apache) —–&amp;gt; CGI Program —–&amp;gt; Db

  Serve...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/getting-start/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago small"
    date="2019-08-09 20:55:00 +0800"
    >Aug  9, 2019</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Getting Started</h3>
            <div class="text-muted small">
              <p>
                





                
  Prerequisites
  Installation    
      Creating a New Site        
          Option 1. Using the Chirpy Starter
          Option 2. Forking on GitHub
        
      
      Installing Dependencie...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


      
        
        <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/getting-start/" class="btn btn-outline-primary"
    prompt="Older">
    <p>Getting Started</p>
  </a>
  

  
  <a href="/posts/mysql-transaction/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>MySQL Transaction</p>
  </a>
  

</div>

      
        
        <!--
  The Disqus lazy loading.
-->



      
    </div>
  </div>
</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center text-muted">
    <div class="footer-left">
      <p class="mb-0">
        © 2021
        <a href="">Jamnii Shao</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        

        

        Powered by 
          <a href="#" target="_blank" rel="noopener">Jekyll</a>
         with 
          <a href="#" target="_blank" rel="noopener">Chirpy</a>
         theme.

      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/api/">api</a>
    
      
      <a class="post-tag" href="/tags/cgi/">CGI</a>
    
      
      <a class="post-tag" href="/tags/getting-started/">getting started</a>
    
      
      <a class="post-tag" href="/tags/lock/">Lock</a>
    
      
      <a class="post-tag" href="/tags/mysql/">MySQL</a>
    
      
      <a class="post-tag" href="/tags/php-fpm/">PHP-FPM</a>
    
      
      <a class="post-tag" href="/tags/transaction/">transaction</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup -->
  <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>




  </body>

</html>

