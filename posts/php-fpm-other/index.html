<!DOCTYPE html>







<html lang="en"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    <!-- i18n for `_javascript/utils/timeago.js` -->
    <meta name="day-prompt" content="days ago">
    <meta name="hour-prompt" content="hours ago">
    <meta name="minute-prompt" content="minutes ago">
    <meta name="justnow-prompt" content="just now">

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型" />
<meta property="og:locale" content="en" />
<meta name="description" content="CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型" />
<meta property="og:description" content="CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型" />
<link rel="canonical" href="http://192.168.222.128:4001/posts/php-fpm-other/" />
<meta property="og:url" content="http://192.168.222.128:4001/posts/php-fpm-other/" />
<meta property="og:site_name" content="Jamnii" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-25T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"headline":"CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型","@type":"BlogPosting","datePublished":"2021-02-25T00:00:00+08:00","dateModified":"2021-02-25T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://192.168.222.128:4001/posts/php-fpm-other/"},"url":"http://192.168.222.128:4001/posts/php-fpm-other/","description":"CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型 | Jamnii
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<!--<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Jamnii">
<meta name="application-name" content="Jamnii">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">-->


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

</head>


  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  

  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end" lang="en">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
          
          <img src="/assets/img/github.png" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Jamnii</a>
    </div>
    <div class="site-subtitle font-italic">an old person of low-spirited.</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/link/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>LINK</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <!--<button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>-->

      
    

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        



<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
    
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->




<!-- images -->



  <!-- add CDN prefix if it exists -->

  

  

  <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

  

  <!-- add image placehoder to prevent layout reflow -->

  

  

  
    
      
      
    

    
    

    
    

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    

    

  
    

    
    

    
    

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    

    

  
    

    
    

    
    

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    
      

      
      

      
      

      

    

    

  

  
  

  

  
  

  




<!-- return -->







<h1 data-toc-skip>CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <div>
    
    

    

    By
    <em>
      
        Jamnii
      
    </em>
  </div>

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago"
    date="2021-02-25 00:00:00 +0800"
    
      data-toggle="tooltip"
      data-placement="bottom"
      title="Thu, Feb 25, 2021, 12:00 AM +0800"
    >Feb 25, 2021</em>

      </span>

      <!-- lastmod date -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="3104 words">
  <em>17 min</em> read</span>


      <!-- page views -->
      
    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>CGI、FastCGI、PHP-FPM、Reactor、I/O复用模型</p>

<h3 id="cgi">CGI<a href="#cgi"><i class="fas fa-hashtag"></i></a></h3></h3>

<p><code class="language-plaintext highlighter-rouge">common gateway interface (公共网关接口)</code></p>

<blockquote>
  <p>请求模式:
        Web Brower(浏览器) —-(通过http协议传输)—-&gt; Http Server(服务器nginx/apache) —–&gt; CGI Program —–&gt; Db</p>

  <p>Server 与 CGI 通过 STDIN/STDOUT(标准的输入/输出)进行数据传递</p>

  <p>nginx(动态加载模块) apache(指定加载模块)</p>
</blockquote>

<h3 id="cgi工作原理">CGI工作原理<a href="#cgi工作原理"><i class="fas fa-hashtag"></i></a></h3></h3>

<blockquote>
  <p>每当客户请求CGI的时候，WEB服务器就请求操作系统生成一个新的CGI解释器进程(如php-cgi.exe)，</p>

  <p>CGI 的一个进程则处理完一个请求后退出，下一个请求来时再创建新进程。</p>

  <p>当然，这样在访问量很少没有并发的情况也行。可是当访问量增大，并发存在，这种方式就不 适合了。于是就有了fastcgi。</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>        单个请求,多个请求重复操作
                (web)
                  ↓
               (server)
                  ↓
            (CGI解释器进程)
                  ↓
             (处理并返回)
</pre></td></tr></tbody></table></code></div></div>

<h3 id="fastcgi">FastCGI<a href="#fastcgi"><i class="fas fa-hashtag"></i></a></h3></h3>

<blockquote>
  <div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>像是一个常驻(long-live)型的CGI，它可以一直执行着，只要激活后，
不会每次都要花费时间去fork一次（这是CGI最为人诟病的fork-and-execute 模式）。
</pre></td></tr></tbody></table></code></div>  </div>
</blockquote>

<blockquote>
  <p>一般情况下，FastCGI的整个工作流程是这样的：</p>

  <p>1.Web Server启动时载入FastCGI进程管理器（IIS ISAPI或Apache Module)</p>

  <p>2.FastCGI进程管理器自身初始化，启动多个CGI解释器进程(可见多个php-cgi)并等待来自Web Server的连接。</p>

  <p>3.当客户端请求到达Web Server时，FastCGI进程管理器选择并连接到一个CGI解释器。 Web server将CGI环境变量和标准输入发送到FastCGI子进程php-cgi。</p>

  <p>4.FastCGI 子进程完成处理后将标准输出和错误信息从同一连接返回Web Server。</p>

  <p>当FastCGI子进程关闭连接时， 请求便告处理完成。</p>

  <p>FastCGI子进程接着等待并处理来自FastCGI进程管理器(运行在Web Server中)的下一个连接。</p>

  <p>在CGI模式中，php-cgi在此便退出了。</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>    |           server
    |---------------------------------
    |  (server start)                |
    |         ↓                      |
    | (FastCGI进程管理器)          ↙   ←  (请求来了)   ←      (web)
    |         ↓  等待请求  → (接活了) → (php-cgi1接客)
    | (php-cgi1,php-cgi2,php-cgi3,..)|    ↓
    |--------------------------------|(处理完成返回)
    |         ↑ 其它羡慕了                  ↓
    |         ←   (干活真开心:)  ←     (php-cgi1回来了)
</pre></td></tr></tbody></table></code></div></div>

<h3 id="php-fpm">php-fpm<a href="#php-fpm"><i class="fas fa-hashtag"></i></a></h3></h3>

<p>PHP内置的一种fast-cgi:</p>

<p>PHP-FPM 即 PHP-Fastcgi Process Manager.</p>

<p>PHP-FPM 是 FastCGI 的实现，并提供了进程管理的功能。</p>

<p>进程包含 master 进程和 worker 进程两种进程。</p>

<p>master 进程只有一个，负责监听端口，接收来自 Web Server 的请求，
而 worker 进程则一般有多个(具体数量根据实际需要配置)，
每个进程内部都嵌入了一个 PHP 解释器，是 PHP 代码真正执行的地方。</p>

<p>Nginx和PHP-FPM的进程间通信有两种方式: 一种是TCP、一种是UNIX Domain Socket。
其中TCP是IP加端口，可以跨服务器。而UNIX Domain Socket不经过网络，只能用于Nginx跟PHP-FPM都在同一服务器的场景。</p>

<h3 id="php生命周期">PHP生命周期<a href="#php生命周期"><i class="fas fa-hashtag"></i></a></h3></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre> PHP程序的启动
              前置初始化(Apache或Nginx相关操作)
              模块初始化       对应扩展 php.dll
              请求初始化       $_SERVER等参数      I
      frame   执行php脚本      code               I   I可以重复执行(一般为框架内容)
              请求处理完成     request            I
              关闭模块        close

 Apache:
       A: php作为Apache的一个模块的启动和终止.
          这次php会初始化一些必要的数据(PHP_MINIT_FUNCTION),
          比如和Apache有关的,这些数据时常驻内存的!终止与之对应.

       B: Apache分配一个页面请求过来的时候,php会有一次启动和终止

 PHP扩展周期:
      http://www.cunmou.com/phpbook/1.md
      Module init、Request init、Request Shutdown、Module shutdown 四个过程
      具体的执行顺序如下
</pre></td></tr></tbody></table></code></div></div>

<p><img data-proofer-ignore data-src="/assets/image/php_time.png" alt="PHP_TIME" /></p>

<h3 id="请求步骤">请求步骤<a href="#请求步骤"><i class="fas fa-hashtag"></i></a></h3></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre>Web Brower(浏览器访问) www.example.com
|
        |
   通过http协议传输
|
        |
    http server
 (服务器nginx/apache)
|
        |
     配置解析
路由到 www.example.com/index.php(根据配置加载,如果是静态文件index.html不会走这里)
|
        |
加载 nginx 的 fast-cgi 模块 (ngx_http_fastcgi_module),配置基于(nginx.conf)
|
        |
fast-cgi 监听 127.0.0.1:9000 地址
通过 fast-cgi 协议将请求转发给 php-fpm 处理,配置基于(php-fpm.conf)
|
        |
请求到达 127.0.0.1:9000 (接收到请求转发到php-fpm)
|
        |
php-fpm 监听 127.0.0.1:9000
可通过 php-fpm.conf 进行修改
(php-fpm 是一个多进程的 fast-cgi 管理程序)
|
        |
php-fpm 接收到请求，启用 worker 进程处理请求
(worker进程 会抢占式的获得 cgi 请求进行处理)
|
        |
    PHP解释器 处理请求
|
        |
     处理详解
        |
|处理过程:等待 php 脚本的解析,等待业务处理的结果返回,
|       完成后回收子进程,这整个的过程是阻塞等待的.
|处理弊端:也就意味着 php-fpm 的进程数有多少能处理的请求也就是多少,
|       假设 php-fpm 有 200 个 worker进程,一个请求将耗费 1 秒的时间,
|       那么简单的来说整个服务器理论上最多可以处理的请求也就是 200 个,QPS 即为 200/s.
|       在高并发的场景下，这样的性能往往是不够的，
|       尽管可以利用 nginx 作为负载均衡配合多台 php-fpm 服务器来提供服务，
|       但由于 php-fpm 的阻塞等待的工作模型，一个请求会占用至少一个 MySQL 连接，
|       多节点高并发下会产生大量的 MySQL 连接，而 MySQL 的最大连接数默认值为 100，尽管可以修改，
|       但显而易见该模式没法很好的应对高并发的场景
        |
|   PHP生命周期(宏都是在walu.c中)
|              前置初始化(Apache或Nginx相关操作)
|              模块初始化       对应扩展 php.dll
|              请求初始化       $_SERVER等参数    [
|      frame   执行php脚本      code                可以重复执行(一般为框架内容)
|              请求处理完成      request          ]
|              关闭模块         close
|
       |
    其它内容
|
       |
nginx 将结果通过 http 返回给浏览器
</pre></td></tr></tbody></table></code></div></div>

<h3 id="php-fpm--nginx">PHP-FPM + Nginx<a href="#php-fpm--nginx"><i class="fas fa-hashtag"></i></a></h3></h3>

<blockquote>
  <p>FPM 是 Master/Worker 模式，启动一个 Master 进程监听来自 Nginx 的请求，再 fork 多个 Worker 进程处理请求。</p>

  <p>每个 Worker 进程只能处理一个请求，单一进程的生命周期参照 <code class="language-plaintext highlighter-rouge">PHP生命周期</code>。</p>

  <p>多进程模型是依赖进程数来解决并发问题，一个进程只能处理一个连接，当启动大量进程，进程调度消耗可能占 CPU 的百分之几十甚至 100%，比如 C10K 问题，多进程模型就力不从心了。</p>
</blockquote>

<h3 id="swoole">Swoole<a href="#swoole"><i class="fas fa-hashtag"></i></a></h3></h3>

<p>运行图：</p>

<p><img data-proofer-ignore data-src="/assets/image/Swoole_Three.svg" alt="运行图" /></p>

<blockquote>
  <p>搜索所得，并非自己总结。</p>

  <p>Swoole 采用的也是 Master/Worker 模式，不同的是 Master 进程有多个 Reactor 线程，Master 只是一个事件发生器，负责监听 Socket 句柄的事件变化。</p>

  <p>Worker 以多进程的方式运行，接收来自 Reactor 线程的请求，并执行回调函数（PHP 编写的）。</p>

  <p>启动 Master 进程的流程大致是：</p>

  <ol>
    <li>
      <p>初始化模块。</p>
    </li>
    <li>
      <p>初始化请求。因为 swoole 需要通过 cli 的方式运行，所以初始化请求时，不会初始化 PHP 的全局变量，如 $_SERVER, $_POST, $_GET 等。</p>
    </li>
    <li>
      <p>执行 PHP 脚本。包括词法、语法分析，变量、函数、类的初始化等，Master 进入监听状态，并不会结束进程。</p>
    </li>
  </ol>

  <p>Swoole 加速的原理</p>

  <ol>
    <li>
      <p>由 Reactor（epoll 的 IO 复用方式）负责监听 Socket 句柄的事件变化，解决高并发问题。</p>
    </li>
    <li>
      <p>通过内存常驻的方式节省 PHP 代码初始化的时间，在使用笨重的框架时，用 swoole 加速效果是非常明显的。</p>
    </li>
  </ol>

  <p>对比不同</p>

  <div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>PHP-FPM

  1. Master 主进程 / Worker 多进程模式。

  2. 启动 Master，通过 FastCGI 协议监听来自 Nginx 传输的请求。

  3. 每个 Worker 进程只对应一个连接，用于执行完整的 PHP 代码。

  4. PHP 代码执行完毕，占用的内存会全部销毁，下一次请求需要重新再进行初始化等各种繁琐的操作。

  5. 只用于 HTTP Server。

Swoole

  1. Master 主进程（由多个 Reactor 线程组成）/ Worker 多进程（或多线程）模式

  2. 启动 Master，初始化 PHP 代码，由 Reactor 监听 Socket 句柄的事件变化。

  3. Reactor 主线程负责子多线程的均衡问题，
     Manager 进程管理 Worker 多进程，包括 TaskWorker 的进程。

  4. 每个 Worker 接受来自 Reactor 的请求，只需要执行回调函数部分的 PHP 代码。

  5. 只在 Master 启动时执行一遍 PHP 初始化代码，Master 进入监听状态，并不会结束进程。

  6. 不仅可以用于 HTTP Server，还可以建立 TCP 连接、WebSocket 连接。
</pre></td></tr></tbody></table></code></div>  </div>
</blockquote>

<h3 id="io多路复用机制">I/O多路复用机制<a href="#io多路复用机制"><i class="fas fa-hashtag"></i></a></h3></h3>

<p><img data-proofer-ignore data-src="/assets/image/epoll.svg" alt="epoll" /></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>I/O多路复用 : 每个进程/线程同时处理 多个连接(I/O多路复用)

利用epoll来实现IO多路复用,将连接信息和事件放到队列中,
依次放到文件事件分派器,事件分派器将事件分发给事件处理器.

c10k：https://www.jianshu.com/p/ba7fa25d3590

用户A-Z -&gt; I/O多路复用(s0,s1,s2,s3) -依次放到-&gt; 文件事件分派器 -&gt; 事件处理器(连接应答处理器1...)
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>c10k(一瞬间1w请求)
    <div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>早期的一个TCP请求,就会创建一个进程(或线程),而进程属于操作系统,是非常昂贵的资源,并且有数量限制.
创建的进程线程多了,数据拷贝频繁（缓存I/O、内核将数据拷贝到用户进程空间、阻塞）,
进程/线程上下文切换消耗大, 导致操作系统崩溃,这就是C10K问题的本质！
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>简单说下epoll(基于Linux)
    <div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>支持一个进程打开大数目的socket描述符(fd)
只对发生变化的文件句柄感兴趣,工作机制类似于"事件"
通过 epoll_create 创建 epoll对象,
linux内核会创建一个eventpoll结构体(
 重要的两个成员:
  红黑树的根节点: 这棵树中存储着所有添加到epoll中的事件，也就是这个epoll监控的事件。
  双向链表rdllist: 保存着将要通过epoll_wait返回给用户的、满足条件的事件。
)
通过 epoll_ctl 注册文件描述符fd,一旦该fd就绪,
内核就会采用类似 callback 的回调机制来激活该fd,
epoll_wait 便可以收到通知, 并通知应用程序.
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>简单示例</p>

    <div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>I/O多路复用(又被称为“事件驱动”)
one, two, ..., six 和 ser 进行聊天
1.逐个询问是否有聊天信息,如果 one 有,那 ser 处理 one 的信息,其它的就卡住.(阻塞)
2.ser 创建多个分身,即为每个用户创建个进程或者线程.(消耗过大)
3.one, two 主动告诉 ser 有信息, ser 依次进行处理, 然后等待其它人的通知.(非阻塞模式)

                                          tcp(ser)

one(fd)(client socket)  - 注册入epoll -&gt;  建立callback event    -&gt;  有变化(fd) -&gt; epoll收到通知 -&gt; 告诉tcp进行处理

two(fd)(client socket)  - 注册入epoll -&gt;  建立callback event    -&gt;  非阻塞

six(fd)(client socket)  - 注册入epoll -&gt;  建立callback event    -&gt;  非阻塞
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>


</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/cgi/'>CGI</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/cgi/"
          class="post-tag no-text-decoration" >CGI</a>
      
      <a href="/tags/php-fpm/"
          class="post-tag no-text-decoration" >PHP-FPM</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recent Update</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/mysql-locks/">MySql Locks</a></li>
      
        
        
        
      <li><a href="/posts/mysql-transaction/">MySQL Transaction</a></li>
      
        
        
        
      <li><a href="/posts/getting-start/">Getting Started</a></li>
      
        
        
        
      <li><a href="/posts/how-to-build-api/">How to build you apis</a></li>
      
        
        
        
      <li><a href="/posts/hight-low-design/">高内聚低耦合</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/api/">api</a>
    
      
      <a class="post-tag" href="/tags/cgi/">CGI</a>
    
      
      <a class="post-tag" href="/tags/getting-started/">getting started</a>
    
      
      <a class="post-tag" href="/tags/lock/">Lock</a>
    
      
      <a class="post-tag" href="/tags/mysql/">MySQL</a>
    
      
      <a class="post-tag" href="/tags/php-fpm/">PHP-FPM</a>
    
      
      <a class="post-tag" href="/tags/transaction/">transaction</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
      
        
        <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->




  
    
    
  
    
    
      
      
        
        
        
      
    
  
    
    
      
      
        
        
        
      
    
  
    
    
      
      
        
        
        
          





  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/mysql-transaction/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago small"
    date="2021-02-20 16:42:00 +0800"
    >Feb 20, 2021</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL Transaction</h3>
            <div class="text-muted small">
              <p>
                





                MySQL 事务主要用于处理操作量大，复杂度高的数据。

1. 基础介绍

2. ACID

Atomicity
原子性: 一个事务被视为一个不可分割的最小工作单元 一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。

事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。

原子性关注状态，要么全部成功，要么全部失败，不存在部分成功...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/mysql-locks/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago small"
    date="2021-02-06 00:00:00 +0800"
    >Feb  6, 2021</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySql Locks</h3>
            <div class="text-muted small">
              <p>
                





                锁是计算机协调多个进程或线程并发访问某一资源的机制。锁保证数据并发访问的一致性、有效性；锁冲突也是影响数据库并发访问性能的一个重要因素。锁是Mysql在服务器层和存储引擎层的的并发控制。
加锁是消耗资源的，锁的各种操作，包括获得锁、检测锁是否已解除、释放锁等。

锁的类型
这里主要介绍表锁和行锁。

表锁
表锁由 MySQL Server 实现，一般在执行 DDL(Data Definiti...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/getting-start/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->





<em class="timeago small"
    date="2019-08-09 20:55:00 +0800"
    >Aug  9, 2019</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Getting Started</h3>
            <div class="text-muted small">
              <p>
                





                
  Prerequisites
  Installation    
      Creating a New Site        
          Option 1. Using the Chirpy Starter
          Option 2. Forking on GitHub
        
      
      Installing Dependencie...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


      
        
        <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/mysql-transaction/" class="btn btn-outline-primary"
    prompt="Older">
    <p>MySQL Transaction</p>
  </a>
  

  
  <span class="btn btn-outline-primary disabled"
    prompt="Newer">
    <p>-</p>
  </span>
  

</div>

      
        
        <!--
  The Disqus lazy loading.
-->



      
    </div>
  </div>
</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center text-muted">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="">Jamnii</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        

        

        Powered by 
          <a href="#" target="_blank" rel="noopener">Jekyll</a>
         with 
          <a href="#" target="_blank" rel="noopener">Chirpy</a>
         theme.

      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/api/">api</a>
    
      
      <a class="post-tag" href="/tags/cgi/">CGI</a>
    
      
      <a class="post-tag" href="/tags/getting-started/">getting started</a>
    
      
      <a class="post-tag" href="/tags/lock/">Lock</a>
    
      
      <a class="post-tag" href="/tags/mysql/">MySQL</a>
    
      
      <a class="post-tag" href="/tags/php-fpm/">PHP-FPM</a>
    
      
      <a class="post-tag" href="/tags/transaction/">transaction</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup -->
  <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>




  </body>

</html>

